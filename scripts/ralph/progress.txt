# Ralph Progress Log
Started: Wed, Jan 29, 2026
Branch: ralph/pdf-extraction-v2
PRD: PRD-H Robust PDF Extraction Pipeline (24 stories)
---

## Codebase Patterns
- Next.js app with app/ directory structure
- Supabase for database and storage
- Claude AI via Anthropic SDK for AI passes
- Modal.com for Python serverless (pdfplumber extraction)
- Types in lib/extraction/types.ts
- Mappings in lib/extraction/mappings/ directory
- Test fixtures in lib/extraction/__tests__/fixtures/
- Database migrations in supabase/migrations/
---

## Architecture Overview
Three-stage extraction pipeline:
1. **Stage 1 (Modal/pdfplumber)**: Deterministic PDF extraction - tables, text by region
2. **Stage 2 (Claude Haiku)**: Document classification, schema mapping
3. **Stage 3 (Claude Sonnet/Opus)**: AI validation, enrichment, SDE suggestions

Modal endpoint: Called via HTTP POST from Next.js
Fallback: If scanned PDF detected and OCR fails, route to Claude Vision
---

## Environment Variables Required
- MODAL_TOKEN_ID: Modal authentication token ID
- MODAL_TOKEN_SECRET: Modal authentication token secret
- ANTHROPIC_API_KEY: For Haiku/Sonnet/Opus calls
---

## Test PDFs Location
C:\Users\bened\OneDrive\Documents\biz-val-test-docs
---

## Wed, Jan 29, 2026 - US-001 (TypeScript Types)
- Created lib/extraction/types.ts (685 lines)
- Stage1Output: pdfplumber extraction with tables, text_by_region, metadata
- Stage2Output: Haiku classification with structured_data, schedule_k, schedule_m1, red_flags
- FinalExtractionOutput: complete pipeline output with validation, SDE suggestions
- FinancialDocumentType: 18 document types supported
- Supporting types: BalanceSheetData (BOY/EOY), ScheduleKData, CovidAdjustments, etc.
- Database types: DocumentExtractionRow, DocumentExtractionInsert
- Typecheck passes, no 'any' types used
- **Learnings:**
  - Include database row types alongside domain types for Supabase compatibility
  - Use Record<string, T> for year-keyed financial data
---

## Wed, Jan 29, 2026 - US-002 through US-006 (Infrastructure & Mapping)
- US-002: Database migration adding extraction pipeline columns
- US-003: Modal Python extraction service with pdfplumber + OCR
- US-004: TypeScript Modal client with retry logic
- US-005: Document classifier with keyword fast path + Haiku fallback
- US-006: Form 1120-S mapping + schema-mapper.ts core
- **Learnings:**
  - Mapping registry pattern allows easy addition of new document types
  - parseNumericValue() must handle parentheses for negatives
  - Haiku is effective for ambiguous field mapping (narrow task)
  - RedFlagIndicators auto-calculated from extracted data
---

## Wed, Jan 29, 2026 - US-007 (Form 1120 C-Corp Mapper)
- Created lib/extraction/mappings/form-1120.ts
- Income section (Lines 1-11): dividends, interest income, gross rents/royalties
- Deductions section (Lines 12-27): officer comp (Line 12) as PRIMARY SDE ADD-BACK
- Tax section (Lines 28-35): income tax (Line 31) add back for pre-tax SDE
- Schedule L Assets and Liabilities with equity section
- Charitable contributions (Line 19) marked as discretionary add-back
- **Learnings:**
  - C-Corp has dedicated Tax section unlike S-Corp
  - Retained earnings in equity (unique to C-Corp structure)
---

## Wed, Jan 29, 2026 - US-008 (Form 1065 Partnership Mapper)
- Created lib/extraction/mappings/form-1065.ts (572 lines)
- Income section (Lines 1-8): gross receipts, COGS, gross profit, other income
- Deductions section (Lines 9-21): guaranteed payments (Line 10) as PRIMARY OWNER COMP
- Schedule L Assets: loans to partners flagged as RED FLAG
- Schedule L Liabilities: partners capital accounts
- Schedule K section (Partners' Distributive Share Items):
  - Section 179 deduction - MUST ADD BACK (accelerated depreciation)
  - Capital gains (short/long term, Section 1231) - non-recurring add-backs
  - Cash distributions for cash flow verification
- **Learnings:**
  - Partnerships use guaranteed payments instead of officer compensation
  - Schedule K critical for partnership SDE calculation
  - Partners capital replaces retained earnings/stockholders equity
---

## Wed, Jan 29, 2026 - US-009 (Schedule C Sole Prop Mapper)
- Created lib/extraction/mappings/schedule-c.ts (410 lines)
- Income section (Lines 1-7): gross receipts, COGS, gross profit, gross income
- Expenses section (Lines 8-27): 20+ expense line items
- Net profit section (Lines 29-31): net profit = owner compensation
- COGS detail section (Part III): inventory tracking
- Vehicle information section (Part IV): business use percentage
- SDE add-backs marked:
  - Net profit (Line 31) - ENTIRE amount is owner comp
  - Home office (Line 30) - full add-back
  - Car/truck (Line 9) - 50% personal typical
  - Meals (Line 24b) - 50% personal typical
  - Depreciation (Line 13) - standard add-back
- **Learnings:**
  - Schedule C has NO balance sheet (sole props don't file Schedule L)
  - Net profit IS the owner's compensation for SDE calculation
  - Vehicle miles help validate business use percentage claims
---

## Wed, Jan 29, 2026 - US-010 (Income Statement Mapper)
- Created lib/extraction/mappings/income-statement.ts (500+ lines)
- Revenue section: gross revenue, discounts, returns, net revenue, other income
- COGS section: COGS total, inventory, purchases, direct labor, gross profit
- Operating expenses section: 25+ common categories including:
  - Officer/owner compensation (PRIMARY SDE ADD-BACK)
  - Salaries, payroll taxes, benefits
  - Rent, utilities, insurance
  - Depreciation, amortization
  - Vehicle, travel, meals (discretionary add-backs)
- Other income/expense section: interest income/expense, asset sale gains/losses
- Bottom line section: operating income, income tax, net income, EBITDA
- **Learnings:**
  - P&L formats vary WIDELY by accounting software
  - Need extensive label variations for each field
  - Haiku critical for ambiguous field matching in P&Ls
  - Owner comp may appear as: Officer Compensation, Owner Salary, Member Draws, etc.
---

## Wed, Jan 29, 2026 - US-011 (Balance Sheet Mapper)
- Created lib/extraction/mappings/balance-sheet.ts (650+ lines)
- Current assets: cash, A/R (gross/allowance/net), inventory, prepaid, loans to shareholders
- Fixed assets: land, buildings, equipment, vehicles, leasehold improvements, accumulated depreciation
- Other assets: goodwill, intangibles, investments, deferred tax assets
- Current liabilities: A/P, accrued expenses, short-term debt, deferred revenue
- Long-term liabilities: long-term debt, mortgages, equipment notes, capital leases
- Equity: common/preferred stock, APIC, members/partners capital, retained earnings, distributions
- RED FLAGS marked:
  - Loans to shareholders (may be disguised distributions)
  - Negative retained earnings (accumulated losses)
  - Loans from shareholders (related party debt)
- **Learnings:**
  - Balance sheets typically more consistent than P&Ls
  - BOY/EOY detection via column headers: "Beginning", "End", date ranges
  - Key validation: Assets = Liabilities + Equity (1% tolerance)
  - Entity-specific equity terms: stockholders vs members vs partners capital
---

## Wed, Jan 29, 2026 - US-012 (Schedule K Mapper)
- Created lib/extraction/mappings/schedule-k.ts (480+ lines)
- Income/Loss section: ordinary business income, rental income, interest, dividends, royalties
- Capital gains section: short-term, long-term, collectibles, unrecaptured 1250, Section 1231
- Deductions section: Section 179 (MUST ADD BACK), charitable contributions
- Self-employment section: guaranteed payments (services/capital/total)
- Credits section: low-income housing, rehabilitation, other credits
- Distributions section: cash and property distributions
- AMT section: depreciation adjustment, depletion
- Foreign transactions section: foreign taxes paid, foreign source income
- **Learnings:**
  - Schedule K appears in both 1120-S and 1065 with slight line number variations
  - Section 179 is CRITICAL - accelerated depreciation that must be added back
  - Capital gains are NON-RECURRING and should be normalized out
  - Distributions useful for cash flow verification (should track net income over time)
  - Guaranteed payments = owner compensation for partnerships
---

## Wed, Jan 29, 2026 - US-013 (Schedule M-1 Mapper)
- Created lib/extraction/mappings/schedule-m1.ts (400+ lines)
- Additions section (Lines 1-6): net income per books, federal income tax, capital losses, expenses not deductible
- Subtractions section (Lines 7-8): income on books not taxed, deductions not charged to books
- Reconciliation section (Line 9): income per return (should match Schedule K)
- Analysis section: retained earnings reconciliation (C-Corp specific)
- Added SCHEDULE_M1 to FinancialDocumentType union
- Added classifier keywords for M-1 detection
- **Learnings:**
  - Schedule M-1 validates extraction accuracy (Line 9 should match Schedule K Line 1)
  - Book-tax differences >5% of revenue warrant investigation
  - Common differences: depreciation (Section 179/bonus), meals (50% limit), state taxes
  - "Income not on books" field may indicate unreported income
  - Travel and entertainment 50% disallowance appears in Line 5a
---

## Wed, Jan 29, 2026 - US-014 (Form 1125-A COGS Detail)
- Created lib/extraction/mappings/form-1125a.ts (350+ lines)
- Inventory method section: beginning/ending inventory
- Purchases and costs section: purchases, labor, Section 263A, other costs
- COGS calculation section: total costs available, final COGS
- Inventory identification section: FIFO, LIFO, specific identification, average cost
- Valuation method section: cost, lower of cost or market, other
- LIFO details section: adoption year, reserve beginning/ending, recapture
- **Learnings:**
  - COGS validation: Beginning + Purchases + Labor + Other - Ending = COGS
  - LIFO vs FIFO significantly affects COGS comparability
  - Section 263A (UNICAP) defers overhead costs - affects cash flow timing
  - LIFO recapture triggered by S-Corp election is non-recurring
---

## Wed, Jan 29, 2026 - US-015 (COVID Adjustment Detection)
- Created lib/extraction/covid-detector.ts (390 lines)
- Keyword patterns for: PPP, EIDL, ERC/ERTC, other COVID relief
- COVID_RELEVANT_YEARS: 2020-2024
- detectCovidAdjustments(): main detection function
  - Searches raw text for COVID keywords
  - Extracts dollar amounts near keywords
  - Analyzes "other income" line for hidden relief
  - Returns CovidDetectionResult with adjustments and warnings
- isLikelyCovidRelief(): field-level COVID check helper
- getCovidSdeAdjustment(): SDE adjustment recommendation
- **Learnings:**
  - COVID items must be SUBTRACTED from earnings (non-recurring income)
  - PPP forgiveness usually in "Other Income" line
  - ERC can appear as payroll tax refund or reduced payroll expense
  - Field names vary: ppp_loan_forgiveness, eidl_advances, employee_retention_credit
  - Need to match existing CovidAdjustments type structure
---

## Wed, Jan 29, 2026 - US-016 (Related Party Detection)
- Created lib/extraction/related-party-detector.ts (440 lines)
- Detection functions for:
  - Loans to shareholders (eoy_loans_to_shareholders > $1,000)
  - Loans from shareholders (eoy_loans_from_shareholders > $1,000)
  - High rent expense (>10% of revenue)
  - Management fees (keyword search + amount threshold)
  - High "other expenses" (>15% of total expenses)
- Configurable thresholds in THRESHOLDS constant
- Severity classification (high/medium/low) based on amount
- Helper functions: detectRelatedPartyIndicators(), mergeRelatedPartyRedFlags(), getRelatedPartySdeAdjustments()
- **Learnings:**
  - StructuredFinancialData uses balance_sheet, not balance_sheet_eoy
  - BalanceSheetData has boy_* and eoy_* prefixed fields
  - RedFlagIndicators uses has_loans_to_shareholders (boolean) + loans_to_shareholders_amount (number)
  - Related party rent is often hidden owner compensation
  - Management fees to related entities typically add back fully
---

## Wed, Jan 29, 2026 - US-017 (Comprehensive Data Validator)
- Created lib/extraction/validation-rules.ts (700+ lines)
- Created lib/extraction/validator.ts (260+ lines)
- 18 validation rules in 9 categories:
  - Balance Sheet (BS001-BS003): equation check, loans to shareholders, negative retained earnings
  - Income Statement (IS001-IS005): gross profit calc, revenue positive, COGS reconciliation, other income %, other deductions %
  - SDE (SDE001-SDE004): officer comp %, Section 179, guaranteed payments, capital gains
  - Schedule M-1 (M1001): book-tax reconciliation
  - Cash Flow (CF001): distributions vs net income
  - COVID (COVID001): relief item detection
  - Industry (IND001): gross margin reasonableness
  - Related Party (RPT001): multiple indicator detection
  - Trend (TREND001): YoY revenue change
- Validator functions:
  - validateExtraction(): main validation against all rules
  - validateSubset(): run specific rule IDs
  - validateCategory(): run rules by category
  - getSdeValidationInfo(): SDE-related info items
  - getCriticalBlockers(): quick pre-processing check
  - formatValidationResults(): human-readable output
  - isDataUsable(): check if data is usable despite warnings
  - getValidationStatus(): status string for database
- **Learnings:**
  - ValidationResult interface requires `passed: boolean` field
  - ValidationResult does NOT have expected_value, actual_value, or suggestion fields (put in message)
  - ScheduleM1Data uses `income_per_schedule_k` not `income_loss_per_return`
  - Validation rules return null if check passes, ValidationResult if fails
---

## Wed, Jan 29, 2026 - US-018 (AI Validation and Enrichment - Stage 3)
- Created lib/extraction/ai-validator.ts (670+ lines)
- Main functions:
  - validateWithAI(): Main Stage 3 function that uses Claude Sonnet/Opus
  - buildValidationPrompt(): Creates detailed prompt with financial summary
  - buildFinancialSummary(): Human-readable data for AI review
  - callClaudeForValidation(): API call with JSON parsing
  - buildYearlyFinancialData(): Converts Stage2 to YearlyFinancialData
  - calculateSdeAddbacksFromData(): Quick SDE estimate without AI call
  - mapDocTypeToEntityType(): Maps document type to entity type
- Escalation logic:
  - Uses Sonnet by default (claude-sonnet-4-20250514)
  - Escalates to Opus if confidence < 70% or errors > 3
  - Returns FinalExtractionOutput with all validation data
- SDE add-backs calculated:
  - Officer compensation / guaranteed payments
  - Depreciation, amortization, interest
  - Section 179 deduction
  - Non-recurring capital gains (excluded)
  - Owner benefits
- **Learnings:**
  - Stage2Output uses `processing_metadata` not `metadata`
  - RedFlagIndicators uses `negative_retained_earnings` not `has_negative_retained_earnings`
  - EntityType enum doesn't include 'UNKNOWN' - use 'LLC' as default
  - Can generate UUID without external library using simple function
---

## Wed, Jan 29, 2026 - US-019 (Cross-Document Validation)
- Created lib/extraction/cross-doc-validator.ts (500 lines)
- Main functions:
  - validateCrossDocument(): Main function for multi-document validation
  - compareTaxVsFinancial(): Tax return vs P&L comparison
  - compareK1VsReturn(): K-1 vs tax return comparison
  - compareYearOverYear(): Year-over-year trend validation
  - summarizeCrossDocValidation(): Human-readable summary
  - isSameEntity(): Entity name matching for grouping
- Comparison types:
  - tax_vs_financial: Revenue, COGS, net income, total assets
  - k1_vs_return: Ordinary income, Section 179, distributions
  - year_over_year: Revenue, gross margin, officer comp, assets
- Tolerance thresholds:
  - Revenue: 2% tolerance
  - Net income: 5% tolerance (allows timing differences)
  - Balance sheet: 1% tolerance
  - YoY change: 30% threshold for flagging
- **Learnings:**
  - Group documents by tax year before comparing
  - K-1 values should be LESS than tax return totals (partner's share)
  - Gross margin shouldn't swing more than 10 percentage points YoY
  - Officer comp changes > 50% YoY warrant investigation
---

## Wed, Jan 29, 2026 - US-020 (Confidence Scoring System)
- Created lib/extraction/confidence-scorer.ts (515 lines)
- Main functions:
  - calculateConfidence(): Main scoring function (weighted 0-100)
  - quickConfidenceCheck(): Lightweight early pipeline check
  - formatConfidenceScore(): Human-readable display
- Score weights (sum to 100):
  - Classification: 20%
  - Data Completeness: 30%
  - Validation: 30%
  - Consistency: 20%
- Escalation thresholds:
  - Score >= 70: Ready for valuation
  - Score 50-69: Opus escalation recommended
  - Score < 50: Human review recommended
- Component calculations:
  - Classification: Based on confidence level, document type, tax year, entity name
  - Data Completeness: Critical fields populated (revenue, COGS, officer comp, etc.)
  - Validation: Errors (-15 each), Warnings (-5 each), Infos (-1 each)
  - Consistency: Balance sheet equation, gross profit calc, COGS reconciliation
- **Learnings:**
  - CrossDocValidationResult is in types.ts, not cross-doc-validator.ts
  - Officer comp can legitimately be 0 - check guaranteed_payments as alternative
  - Balance sheet optional for Schedule C (sole proprietors)
---

## Wed, Jan 29, 2026 - US-021 (Unified Extraction Pipeline Orchestrator)
- Created lib/extraction/pipeline.ts (580 lines)
- Main functions:
  - extractDocumentPipeline(): Main pipeline function (entry point)
  - extractMultipleDocuments(): Batch processing
  - runStage1(): Modal/pdfplumber extraction with retry
  - runStage2(): Classification and schema mapping
  - runStage3(): AI validation and enrichment
  - createBasicFinalOutput(): Fallback output without AI
- Pipeline features:
  - Progress events via callback (stage1/stage2/stage3/complete/error)
  - Partial failure handling (continue with successful stages)
  - Retry logic: exponential backoff (1s, 3s, 9s), 3 max retries
  - Scanned PDF detection with Claude Vision fallback flag
  - Configurable: skipAiValidation, forceOpus, maxRetries, modalEndpointUrl
- Stage orchestration:
  - Stage 1 → Stage 2 → Stage 3 (sequential)
  - If Stage 3 fails, creates basic output from Stage 2
  - Returns partial results even on failure
- **Learnings:**
  - Use emitProgress wrapper to catch callback errors
  - Return needsClaudeVision flag so caller can decide fallback strategy
  - Keep createBasicFinalOutput for when AI validation is skipped or fails
---

## Wed, Jan 29, 2026 - US-022 (Extraction API Route)
- Created app/api/reports/[id]/extract-v2/route.ts (400 lines)
- POST handler:
  - Fetches documents from Supabase storage
  - Runs extraction pipeline for each document
  - Stores results in document_extractions table
  - Updates report status (extracting/extracted/extraction_failed)
  - Returns extraction summary with confidence scores
- GET handler:
  - Returns extraction status for report
  - Includes document count, success/fail counts
  - Average confidence score across documents
- Optional params:
  - documentIds: Extract specific documents only
  - skipAiValidation: Skip Stage 3 for faster processing
- **Learnings:**
  - Use lazy-initialized Supabase client to avoid build-time errors
  - Convert Blob from storage to Buffer using arrayBuffer()
  - Upsert to document_extractions with onConflict: 'report_id,document_id'
  - Map extraction status to report_status carefully
---

