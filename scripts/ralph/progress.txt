# Ralph Progress: Modal Extraction Enhancement

## Branch: ralph/modal-extraction-enhancement

## Status: COMPLETE (24/24 stories completed)

## Codebase Patterns
- Entity type determines owner compensation location: S-Corp uses officer comp, Partnership uses guaranteed payments, Sole Prop uses net income
- Section 179 deduction is in Schedule K, often missed when calculating SDE
- COVID adjustments (PPP/EIDL/ERC) should be normalized out of earnings
- All extraction accessor functions use ?? 0 defaults for null safety
- Feature flags read from environment variables: FEATURE_MODAL_EXTRACTION, FEATURE_CLAUDE_VISION_FALLBACK, etc.
- Modal extract_pdf.py is a single Python file that must contain all extractors (Modal constraint)
- snake_case for all field names in extraction output
- Standalone balance sheet takes precedence over Schedule L for asset values
- Virginia only for state tax support (architecture supports adding states later)
- Proceed with partial data on extraction failure rather than hard fail

---

## 2026-01-30 - US-001

### Completed: Implement DocumentClassifier with balance sheet detection

**What was implemented:**
- Added DocumentClassifier class with classify() method
- ClassificationResult dataclass with document_type, entity_type, tax_year, jurisdiction, confidence_score, classification_reasons
- Document signatures for: form_1120s, form_1120, form_1065, schedule_c, va_form_500, balance_sheet, income_statement
- Score calculation based on: pattern matches (0.4), filename hints (0.2), required fields (0.2), structural signals (0.3 for balance sheets)
- Balance date extraction for "As of [date]" format common in QuickBooks exports
- Classification metadata added to parse_financial_data() output

**Files changed:**
- modal/extract_pdf.py - Added DocumentClassifier, ClassificationResult, updated parse_financial_data()
- lib/extraction/types.ts - Added 'Balance Sheet', 'Virginia Form 500', 'Income Statement' to DocumentType; Added DocumentTypeInternal and Jurisdiction types

**Learnings for future iterations:**
- Balance sheets use structural signals (ASSETS, LIABILITIES, EQUITY) rather than required fields since labels vary by accounting software
- QuickBooks balance sheets use "As of [date]" format for dates, not tax year patterns
- Virginia Form 500 patterns must not conflict with federal 1120 patterns (both have "corporation income tax")
- Classification confidence scores should be normalized to 0-1 range using min(score, 1.0)

---


## 2026-01-30 - US-017 through US-024 (Continued Session)

### US-017: Update API route to handle new document types
- Added document type routing in lib/extraction.ts
- handleBalanceSheetExtraction(): COVID loan balances, shareholder loans flags
- handleStateTaxExtraction(): Virginia Form 500 with jurisdiction
- handleFederalTaxExtraction(): COVID adjustments from federal forms
- Updated extraction result to include document_type and extraction_status
- Store document_type in document_extractions metadata

### US-018: Update valuation engine to use balance sheet data
- Added source field to BalanceSheetData ('standalone' | 'schedule_l' | 'estimated')
- Added eidl_loan_balance and ppp_loan_balance to long_term_liabilities
- Added working_capital calculation
- Updated mapBalanceSheet() to accept standalone balance sheet with priority

### US-019: Update valuation engine for COVID normalization
- Added CovidAdjustmentsData interface
- Updated calculateSDEForYear() with COVID adjustment subtraction
- COVID items subtracted from SDE for 2020-2021 normalization
- Added calculateCovidAdjustmentForYear() helper

### US-020: Update orchestrator prompts for COVID and balance sheet handling
- Updated Pass 5 with COVID adjustment section (E.1)
- PPP, EIDL, ERC handling with SUBTRACT treatment
- Added balance sheet red flags section (E.2)
- Pass 2/3 deprecated in favor of Modal extraction

### US-021: Update PDF generator for source document display
- Added source_documents to ReportData interface
- Added Source Documents section with table in PDF
- Shows Document Type, Filename, Tax Year, Jurisdiction

### US-022: Update PDF generator for COVID adjustment disclosure
- Added covid_adjustments to ReportData
- Added COVID disclosure section with warning styling
- Shows PPP, EIDL, ERC amounts and treatment

### US-023: Create integration test for balance sheet extraction
- Created 19 tests for balance sheet extraction
- Tests: asset/liability extraction, COVID loans, red flags, BOY/EOY values

### US-024: Create integration test for Virginia Form 500 extraction
- Created 18 tests for VA Form 500 extraction
- Tests: federal/VA taxable income, apportionment, jurisdiction, tax calculation

**All 24 user stories COMPLETE and passing**

---
