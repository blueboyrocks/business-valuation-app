# Ralph Progress Log
Started: Wed, Jan 29, 2026
Branch: ralph/pdf-extraction-v2
PRD: PRD-H Robust PDF Extraction Pipeline (24 stories)
---

## Codebase Patterns
- Next.js app with app/ directory structure
- Supabase for database and storage
- Claude AI via Anthropic SDK for AI passes
- Modal.com for Python serverless (pdfplumber extraction)
- Types in lib/extraction/types.ts
- Mappings in lib/extraction/mappings/ directory
- Test fixtures in lib/extraction/__tests__/fixtures/
- Database migrations in supabase/migrations/
---

## Architecture Overview
Three-stage extraction pipeline:
1. **Stage 1 (Modal/pdfplumber)**: Deterministic PDF extraction - tables, text by region
2. **Stage 2 (Claude Haiku)**: Document classification, schema mapping
3. **Stage 3 (Claude Sonnet/Opus)**: AI validation, enrichment, SDE suggestions

Modal endpoint: Called via HTTP POST from Next.js
Fallback: If scanned PDF detected and OCR fails, route to Claude Vision
---

## Environment Variables Required
- MODAL_TOKEN_ID: Modal authentication token ID
- MODAL_TOKEN_SECRET: Modal authentication token secret
- ANTHROPIC_API_KEY: For Haiku/Sonnet/Opus calls
---

## Test PDFs Location
C:\Users\bened\OneDrive\Documents\biz-val-test-docs
---

## Wed, Jan 29, 2026 - US-001 (TypeScript Types)
- Created lib/extraction/types.ts (685 lines)
- Stage1Output: pdfplumber extraction with tables, text_by_region, metadata
- Stage2Output: Haiku classification with structured_data, schedule_k, schedule_m1, red_flags
- FinalExtractionOutput: complete pipeline output with validation, SDE suggestions
- FinancialDocumentType: 18 document types supported
- Supporting types: BalanceSheetData (BOY/EOY), ScheduleKData, CovidAdjustments, etc.
- Database types: DocumentExtractionRow, DocumentExtractionInsert
- Typecheck passes, no 'any' types used
- **Learnings:**
  - Include database row types alongside domain types for Supabase compatibility
  - Use Record<string, T> for year-keyed financial data
---

## Wed, Jan 29, 2026 - US-002 through US-006 (Infrastructure & Mapping)
- US-002: Database migration adding extraction pipeline columns
- US-003: Modal Python extraction service with pdfplumber + OCR
- US-004: TypeScript Modal client with retry logic
- US-005: Document classifier with keyword fast path + Haiku fallback
- US-006: Form 1120-S mapping + schema-mapper.ts core
- **Learnings:**
  - Mapping registry pattern allows easy addition of new document types
  - parseNumericValue() must handle parentheses for negatives
  - Haiku is effective for ambiguous field mapping (narrow task)
  - RedFlagIndicators auto-calculated from extracted data
---

## Wed, Jan 29, 2026 - US-007 (Form 1120 C-Corp Mapper)
- Created lib/extraction/mappings/form-1120.ts
- Income section (Lines 1-11): dividends, interest income, gross rents/royalties
- Deductions section (Lines 12-27): officer comp (Line 12) as PRIMARY SDE ADD-BACK
- Tax section (Lines 28-35): income tax (Line 31) add back for pre-tax SDE
- Schedule L Assets and Liabilities with equity section
- Charitable contributions (Line 19) marked as discretionary add-back
- **Learnings:**
  - C-Corp has dedicated Tax section unlike S-Corp
  - Retained earnings in equity (unique to C-Corp structure)
---

## Wed, Jan 29, 2026 - US-008 (Form 1065 Partnership Mapper)
- Created lib/extraction/mappings/form-1065.ts (572 lines)
- Income section (Lines 1-8): gross receipts, COGS, gross profit, other income
- Deductions section (Lines 9-21): guaranteed payments (Line 10) as PRIMARY OWNER COMP
- Schedule L Assets: loans to partners flagged as RED FLAG
- Schedule L Liabilities: partners capital accounts
- Schedule K section (Partners' Distributive Share Items):
  - Section 179 deduction - MUST ADD BACK (accelerated depreciation)
  - Capital gains (short/long term, Section 1231) - non-recurring add-backs
  - Cash distributions for cash flow verification
- **Learnings:**
  - Partnerships use guaranteed payments instead of officer compensation
  - Schedule K critical for partnership SDE calculation
  - Partners capital replaces retained earnings/stockholders equity
---

## Wed, Jan 29, 2026 - US-009 (Schedule C Sole Prop Mapper)
- Created lib/extraction/mappings/schedule-c.ts (410 lines)
- Income section (Lines 1-7): gross receipts, COGS, gross profit, gross income
- Expenses section (Lines 8-27): 20+ expense line items
- Net profit section (Lines 29-31): net profit = owner compensation
- COGS detail section (Part III): inventory tracking
- Vehicle information section (Part IV): business use percentage
- SDE add-backs marked:
  - Net profit (Line 31) - ENTIRE amount is owner comp
  - Home office (Line 30) - full add-back
  - Car/truck (Line 9) - 50% personal typical
  - Meals (Line 24b) - 50% personal typical
  - Depreciation (Line 13) - standard add-back
- **Learnings:**
  - Schedule C has NO balance sheet (sole props don't file Schedule L)
  - Net profit IS the owner's compensation for SDE calculation
  - Vehicle miles help validate business use percentage claims
---

## Wed, Jan 29, 2026 - US-010 (Income Statement Mapper)
- Created lib/extraction/mappings/income-statement.ts (500+ lines)
- Revenue section: gross revenue, discounts, returns, net revenue, other income
- COGS section: COGS total, inventory, purchases, direct labor, gross profit
- Operating expenses section: 25+ common categories including:
  - Officer/owner compensation (PRIMARY SDE ADD-BACK)
  - Salaries, payroll taxes, benefits
  - Rent, utilities, insurance
  - Depreciation, amortization
  - Vehicle, travel, meals (discretionary add-backs)
- Other income/expense section: interest income/expense, asset sale gains/losses
- Bottom line section: operating income, income tax, net income, EBITDA
- **Learnings:**
  - P&L formats vary WIDELY by accounting software
  - Need extensive label variations for each field
  - Haiku critical for ambiguous field matching in P&Ls
  - Owner comp may appear as: Officer Compensation, Owner Salary, Member Draws, etc.
---

## Wed, Jan 29, 2026 - US-011 (Balance Sheet Mapper)
- Created lib/extraction/mappings/balance-sheet.ts (650+ lines)
- Current assets: cash, A/R (gross/allowance/net), inventory, prepaid, loans to shareholders
- Fixed assets: land, buildings, equipment, vehicles, leasehold improvements, accumulated depreciation
- Other assets: goodwill, intangibles, investments, deferred tax assets
- Current liabilities: A/P, accrued expenses, short-term debt, deferred revenue
- Long-term liabilities: long-term debt, mortgages, equipment notes, capital leases
- Equity: common/preferred stock, APIC, members/partners capital, retained earnings, distributions
- RED FLAGS marked:
  - Loans to shareholders (may be disguised distributions)
  - Negative retained earnings (accumulated losses)
  - Loans from shareholders (related party debt)
- **Learnings:**
  - Balance sheets typically more consistent than P&Ls
  - BOY/EOY detection via column headers: "Beginning", "End", date ranges
  - Key validation: Assets = Liabilities + Equity (1% tolerance)
  - Entity-specific equity terms: stockholders vs members vs partners capital
---

## Wed, Jan 29, 2026 - US-012 (Schedule K Mapper)
- Created lib/extraction/mappings/schedule-k.ts (480+ lines)
- Income/Loss section: ordinary business income, rental income, interest, dividends, royalties
- Capital gains section: short-term, long-term, collectibles, unrecaptured 1250, Section 1231
- Deductions section: Section 179 (MUST ADD BACK), charitable contributions
- Self-employment section: guaranteed payments (services/capital/total)
- Credits section: low-income housing, rehabilitation, other credits
- Distributions section: cash and property distributions
- AMT section: depreciation adjustment, depletion
- Foreign transactions section: foreign taxes paid, foreign source income
- **Learnings:**
  - Schedule K appears in both 1120-S and 1065 with slight line number variations
  - Section 179 is CRITICAL - accelerated depreciation that must be added back
  - Capital gains are NON-RECURRING and should be normalized out
  - Distributions useful for cash flow verification (should track net income over time)
  - Guaranteed payments = owner compensation for partnerships
---

## Wed, Jan 29, 2026 - US-013 (Schedule M-1 Mapper)
- Created lib/extraction/mappings/schedule-m1.ts (400+ lines)
- Additions section (Lines 1-6): net income per books, federal income tax, capital losses, expenses not deductible
- Subtractions section (Lines 7-8): income on books not taxed, deductions not charged to books
- Reconciliation section (Line 9): income per return (should match Schedule K)
- Analysis section: retained earnings reconciliation (C-Corp specific)
- Added SCHEDULE_M1 to FinancialDocumentType union
- Added classifier keywords for M-1 detection
- **Learnings:**
  - Schedule M-1 validates extraction accuracy (Line 9 should match Schedule K Line 1)
  - Book-tax differences >5% of revenue warrant investigation
  - Common differences: depreciation (Section 179/bonus), meals (50% limit), state taxes
  - "Income not on books" field may indicate unreported income
  - Travel and entertainment 50% disallowance appears in Line 5a
---

## Wed, Jan 29, 2026 - US-014 (Form 1125-A COGS Detail)
- Created lib/extraction/mappings/form-1125a.ts (350+ lines)
- Inventory method section: beginning/ending inventory
- Purchases and costs section: purchases, labor, Section 263A, other costs
- COGS calculation section: total costs available, final COGS
- Inventory identification section: FIFO, LIFO, specific identification, average cost
- Valuation method section: cost, lower of cost or market, other
- LIFO details section: adoption year, reserve beginning/ending, recapture
- **Learnings:**
  - COGS validation: Beginning + Purchases + Labor + Other - Ending = COGS
  - LIFO vs FIFO significantly affects COGS comparability
  - Section 263A (UNICAP) defers overhead costs - affects cash flow timing
  - LIFO recapture triggered by S-Corp election is non-recurring
---

