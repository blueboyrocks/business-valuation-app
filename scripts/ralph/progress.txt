# Ralph Progress: Modal Extraction Integration

## Branch: ralph/modal-extraction-integration

## Status: IN PROGRESS (7/24 stories completed)

## Codebase Patterns
- Entity type determines owner compensation location: S-Corp uses officer comp, Partnership uses guaranteed payments, Sole Prop uses net income
- Section 179 deduction is in Schedule K, often missed when calculating SDE
- COVID adjustments (PPP/EIDL/ERC) should be normalized out of earnings
- All extraction accessor functions use ?? 0 defaults for null safety
- Feature flags read from environment variables: FEATURE_MODAL_EXTRACTION, FEATURE_CLAUDE_VISION_FALLBACK, etc.

---

## 2026-01-29 - US-001 through US-007

### Completed Stories:

**US-001: Create centralized feature flags module**
- Created lib/feature-flags.ts
- Functions: getFeatureFlags(), isModalExtractionEnabled(), isClaudeVisionFallbackAllowed(), logFeatureFlags()
- Environment variables: FEATURE_MODAL_EXTRACTION, FEATURE_CLAUDE_VISION_FALLBACK, FEATURE_EXTRACTION_DEBUG, MODAL_FAIL_MODE

**US-002: Create extraction error types and handlers**
- Created lib/extraction/errors.ts
- ExtractionErrorCode enum with 7 codes
- handleExtractionError() for consistent error responses
- ExtractionException class for throwing typed errors

**US-003: Create scanned PDF detector**
- Created lib/extraction/scanned-pdf-detector.ts
- analyzeTextDensity() with thresholds: <50=scanned, <500=warn, >=500=proceed
- detectFromModalResponse() to use Modal's is_scanned flag
- 17 unit tests passing

**US-004: Create typed data accessor functions**
- Created lib/extraction/types.ts with FinalExtractionOutput and all related types
- Created lib/extraction/data-accessors.ts with entity-type-aware accessors
- Key functions: getOwnerCompensation(), getDepreciationAddBack(), getCovidAdjustments()

**US-005: Create SDE calculation accessors**
- Added to data-accessors.ts: getAllSdeAddBacks(), getNormalizedNetIncome(), calculateSDE()
- Categories: owner_compensation, depreciation, section_179, amortization, interest, capital_gains, covid_adjustments
- getWeightedAverageSDE() with weights 3,2,1 for most recent years
- 20 unit tests passing

**US-006: Validate FinalExtractionOutput type completeness**
- Verified types.ts has all required fields
- schedule_k.section_179_deduction, owner_info.guaranteed_payments, covid_adjustments, red_flags all present

**US-007: Add extraction data loader**
- Created lib/extraction/loader.ts
- checkExistingExtraction(), loadExtractionData(), storeExtractionData(), updateExtractionStatus()
- Works with document_extractions table

### Files Created/Modified:
- lib/feature-flags.ts (NEW)
- lib/extraction/errors.ts (NEW)
- lib/extraction/scanned-pdf-detector.ts (NEW)
- lib/extraction/types.ts (NEW)
- lib/extraction/data-accessors.ts (NEW)
- lib/extraction/loader.ts (NEW)
- lib/extraction/__tests__/scanned-pdf-detector.test.ts (NEW)
- lib/extraction/__tests__/data-accessors.test.ts (NEW)
- .env.example (MODIFIED - added feature flag env vars)

### Remaining Stories (17):
- US-008 to US-024 pending (see prd.json for details)
- Next priority: US-008 (Wire Modal extraction), US-010 (Feature flag check in orchestrator)

---
