{
  "project": "ValuationPro",
  "branchName": "ralph/modal-extraction-enhancement",
  "description": "Modal PDF Extraction Enhancement - Universal document support for balance sheets, Virginia state taxes, and enhanced federal form extraction",
  "userStories": [
    {
      "id": "US-001",
      "title": "Implement DocumentClassifier with balance sheet detection",
      "description": "As a valuation system, I need to classify uploaded documents by type so the correct extractor is used. Start with balance sheet detection since that's the most common gap.",
      "acceptanceCriteria": [
        "Add DocumentClassifier class to modal/extract_pdf.py with classify() method",
        "Returns ClassificationResult with document_type, entity_type, tax_year, confidence_score",
        "Add balance_sheet detection patterns: 'Balance Sheet', 'Statement of Financial Position', 'ASSETS', 'LIABILITIES', 'EQUITY'",
        "Detect balance date format: 'As of [date]' to extract tax_year",
        "Add 'balance_sheet' to DocumentType enum in lib/extraction/types.ts",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Implemented DocumentClassifier with balance_sheet, va_form_500, income_statement patterns. Added types to lib/extraction/types.ts."
    },
    {
      "id": "US-002",
      "title": "Add Virginia Form 500 classification",
      "description": "As a valuation system, I need to detect Virginia state tax returns so state-specific adjustments can be extracted.",
      "acceptanceCriteria": [
        "Add va_form_500 patterns to DocumentClassifier: 'Virginia', 'Form 500', 'Department of Taxation'",
        "Detect sub-forms: 500ADJ, 500FED, 500A patterns",
        "Set jurisdiction = 'VA' in classification result",
        "Extract tax year from form header",
        "Add 'va_form_500' to DocumentType enum in lib/extraction/types.ts",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "VA Form 500 patterns added including sub-forms 500ADJ, 500FED, 500A. jurisdiction='VA' set in classification."
    },
    {
      "id": "US-003",
      "title": "Implement BalanceSheetExtractor base class",
      "description": "As a valuation system, I need to extract standard balance sheet fields so asset and liability data feeds into valuation.",
      "acceptanceCriteria": [
        "Add BalanceSheetExtractor class to modal/extract_pdf.py inheriting from BaseExtractor",
        "Extract total_assets, total_liabilities, total_equity from both text and table formats",
        "Extract cash, accounts_receivable, inventory, retained_earnings, shareholder_distributions",
        "Handle negative numbers in parentheses format: (1,234.56) = -1234.56",
        "Return ExtractionResult with document_type='balance_sheet'",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Implemented BalanceSheetExtractor with BaseExtractor base class. Handles QuickBooks format with hierarchical parsing."
    },
    {
      "id": "US-004",
      "title": "Extract hierarchical asset structure from balance sheets",
      "description": "As a valuation system, I need to parse nested asset categories in QuickBooks-style balance sheets.",
      "acceptanceCriteria": [
        "Parse hierarchy: Current Assets > Bank Accounts > individual accounts",
        "Parse hierarchy: Fixed Assets > Vehicles, Equipment, Furniture with subtotals",
        "Extract accumulated_depreciation as negative value",
        "Handle 'Total [Category]' rollup lines",
        "Calculate net_fixed_assets = fixed_assets_gross - accumulated_depreciation",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Implemented in US-003 BalanceSheetExtractor with _extract_assets_section() for hierarchical parsing"
    },
    {
      "id": "US-005",
      "title": "Detect COVID loans in balance sheet liabilities",
      "description": "As a valuation analyst, I need to identify EIDL and PPP loans in balance sheets for COVID normalization.",
      "acceptanceCriteria": [
        "Detect EIDL patterns: 'EIDL LOAN', 'EIDL-', 'Economic Injury'",
        "Detect PPP patterns: 'PPP', 'Paycheck Protection', 'PPP-Loan'",
        "Extract loan balances from Long-Term Liabilities section",
        "Add eidl_loan_balance and ppp_loan_balance to covid_adjustments in extraction output",
        "Add extraction_note when COVID loan detected",
        "Update FinalExtractionOutput.covid_adjustments type to include loan balances in lib/extraction/types.ts",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Implemented in US-003 BalanceSheetExtractor._extract_liabilities_section(). Updated types.ts CovidAdjustments interface."
    },
    {
      "id": "US-006",
      "title": "Detect balance sheet red flags",
      "description": "As a valuation analyst, I need to identify balance sheet anomalies for investigation before finalizing valuation.",
      "acceptanceCriteria": [
        "Flag loans_to_shareholders > 0 with amount",
        "Flag negative_retained_earnings with value",
        "Flag shareholder_distributions > annual net income",
        "Flag large 'Due from' related party balances",
        "Add flags to red_flags dict in extraction output",
        "Ensure lib/extraction/types.ts red_flags interface has loans_to_shareholders, negative_retained_earnings fields",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Implemented in US-003 BalanceSheetExtractor with add_red_flag(). Updated RedFlags interface in types.ts."
    },
    {
      "id": "US-007",
      "title": "Implement VirginiaForm500Extractor base",
      "description": "As a valuation system, I need to extract Virginia corporate income tax data for state-level adjustments.",
      "acceptanceCriteria": [
        "Add VirginiaForm500Extractor class to modal/extract_pdf.py",
        "Extract federal_taxable_income, virginia_taxable_income from Page 2",
        "Extract virginia_additions, virginia_subtractions",
        "Extract FEIN, business_name, NAICS code from header",
        "Set entity_type = 'Corporation' and jurisdiction = 'VA'",
        "Return ExtractionResult with document_type='va_form_500'",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Implemented VirginiaForm500Extractor with full extraction capabilities"
    },
    {
      "id": "US-008",
      "title": "Extract Schedule 500FED federal crosswalk data",
      "description": "As a valuation system, I need to capture federal line item crosswalk from VA returns for depreciation and NOL data.",
      "acceptanceCriteria": [
        "Extract Federal Taxable Income before NOL from Schedule 500FED",
        "Extract Net Operating Loss deduction",
        "Extract Other depreciation (Line 11)",
        "Add extraction_note linking to federal form fields",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Implemented in VirginiaForm500Extractor._extract_schedule_500fed()"
    },
    {
      "id": "US-009",
      "title": "Extract Schedule 500A apportionment percentage",
      "description": "As a valuation system, I need multi-state apportionment percentage to calculate Virginia-only income.",
      "acceptanceCriteria": [
        "Detect multi-factor formula checkbox on Schedule 500A",
        "Extract Property factor, Payroll factor, Sales factor percentages",
        "Extract Multi-Factor Percentage (double-weighted sales)",
        "Add extraction_note if apportionment < 100%",
        "Add apportionment_percentage to state_tax_data in extraction output",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Implemented in VirginiaForm500Extractor._extract_apportionment(). Defaults to 100% for single-state."
    },
    {
      "id": "US-010",
      "title": "Enhance Form 1120-S extractor with Schedule K",
      "description": "As a valuation system, I need all Schedule K line items for Section 179, capital gains, and distributions.",
      "acceptanceCriteria": [
        "Extract Section 179 deduction (Line 11/12a) into schedule_k.section_179_deduction",
        "Extract net short-term + long-term capital gain (Lines 7, 8a) into schedule_k.capital_gains",
        "Extract distributions - cash (Line 16a) and property (Line 16b)",
        "Verify ordinary income matches Page 1 Line 21",
        "Ensure lib/extraction/types.ts schedule_k interface has section_179_deduction, capital_gains, distributions",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Added Schedule K patterns for Section 179, capital gains, distributions. Updated ScheduleK interface."
    },
    {
      "id": "US-011",
      "title": "Enhance Form 1120-S extractor with Schedule L balance sheet",
      "description": "As a valuation system, I need embedded balance sheet from Schedule L for BOY and EOY balances.",
      "acceptanceCriteria": [
        "Extract BOY (beginning of year) column values for all asset lines (1-14)",
        "Extract EOY (end of year) column values for all asset lines",
        "Extract BOY and EOY for liability lines (15-26)",
        "Populate balance_sheet.boy_* and balance_sheet.eoy_* fields",
        "Verify total_assets = total_liabilities + equity",
        "Update lib/extraction/types.ts balance_sheet interface with boy_* and eoy_* fields",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Added BOY/EOY patterns to extract_amounts_from_text. Updated BalanceSheet interface with boy_*/eoy_* fields."
    },
    {
      "id": "US-012",
      "title": "Add COVID adjustment extraction from federal forms",
      "description": "As a valuation analyst, I need to identify COVID-related items in tax returns for proper normalization of 2020-2021 valuations.",
      "acceptanceCriteria": [
        "Detect PPP loan forgiveness patterns (shows as income or equity adjustment)",
        "Detect EIDL advance grants in other income",
        "Detect Employee Retention Credit (shows as reduction to wages expense)",
        "Add extraction_note explaining each COVID adjustment found",
        "Populate covid_adjustments dict with ppp_loan_forgiveness, eidl_advances, employee_retention_credit",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Added COVID patterns for PPP forgiveness, EIDL advance, ERC. Added covid_adjustments to parse_financial_data output."
    },
    {
      "id": "US-013",
      "title": "Implement ExtractorFactory for document routing",
      "description": "As a developer, I need a factory to create the appropriate extractor based on document classification.",
      "acceptanceCriteria": [
        "Add ExtractorFactory class to modal/extract_pdf.py",
        "Map document_type to extractor class: form_1120s->Form1120SExtractor, balance_sheet->BalanceSheetExtractor, va_form_500->VirginiaForm500Extractor",
        "create() method returns appropriate extractor instance",
        "Fall back to GenericExtractor for unknown document types",
        "Wire factory into main extract_pdf() function",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": true,
      "notes": "Implemented ExtractorFactory with EXTRACTOR_MAP. Wired into main extract_pdf() function."
    },
    {
      "id": "US-014",
      "title": "Implement MultiYearAggregator for combining documents",
      "description": "As a valuation system, I need to combine data from multiple documents into a unified FinalExtractionOutput.",
      "acceptanceCriteria": [
        "Add MultiYearAggregator class to modal/extract_pdf.py",
        "Accept list of ExtractionResult from multiple extractors",
        "Group financial data by tax_year in financial_data dict",
        "Merge company_info (prefer federal over state over balance sheet)",
        "Combine balance_sheet data from standalone + Schedule L",
        "Return single unified extraction response",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": "Implemented MultiYearAggregator with aggregate() method, groups by year, merges company_info."
    },
    {
      "id": "US-015",
      "title": "Implement conflict resolution for multi-document data",
      "description": "As a valuation system, I need to handle conflicts when multiple sources provide different values for the same field.",
      "acceptanceCriteria": [
        "Priority order: Federal Tax Return > State Return > Standalone Balance Sheet > Income Statement",
        "Track data_source for each field in extraction output",
        "Flag conflicts with >5% difference as extraction_notes",
        "Use highest confidence_score source when priority is equal",
        "Standalone balance sheet takes precedence over Schedule L for asset values (per user requirement)",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": "Implemented in MultiYearAggregator._merge_year_data() with SOURCE_PRIORITY dict and conflict logging."
    },
    {
      "id": "US-016",
      "title": "Implement ExtractionValidator for quality checks",
      "description": "As a valuation system, I need to validate extraction completeness and accuracy before passing to downstream systems.",
      "acceptanceCriteria": [
        "Add ExtractionValidator class to modal/extract_pdf.py",
        "Check required fields present: revenue, net_income for tax forms; total_assets, total_liabilities for balance sheets",
        "Check balance sheet balances: total_assets = total_liabilities + total_equity (within 1% tolerance)",
        "Calculate overall confidence_score (0.0-1.0)",
        "Set validation.status: 'complete' (>85% confidence), 'partial' (50-85%), 'failed' (<50%)",
        "Add validation.issues array with specific problems found",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": true,
      "notes": "Implemented ExtractionValidator with required field checks, balance sheet validation, income statement ties."
    },
    {
      "id": "US-017",
      "title": "Update API route to handle new document types",
      "description": "As a developer, I need the extraction API route to handle balance_sheet and va_form_500 document types from Modal.",
      "acceptanceCriteria": [
        "Update app/api/reports/[id]/extract/route.ts to handle new document_type values",
        "Add routing logic: balance_sheet -> handleBalanceSheetExtraction(), va_form_500 -> handleStateTaxExtraction()",
        "Store new document types in document_extractions table with appropriate metadata",
        "Return appropriate status codes and messages for partial extractions",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Updated lib/extraction.ts with document type routing. Added handleBalanceSheetExtraction(), handleStateTaxExtraction(), handleFederalTaxExtraction(). Stores document_type in metadata. Returns partial status for incomplete extractions."
    },
    {
      "id": "US-018",
      "title": "Update valuation engine to use balance sheet data",
      "description": "As a developer, I need the calculation engine to incorporate balance sheet data for asset-based valuation approach.",
      "acceptanceCriteria": [
        "Update lib/calculations/types.ts ValuationInputs interface with balance_sheet fields",
        "Add fields: total_assets, total_liabilities, net_fixed_assets, working_capital, shareholder_loans",
        "Update mapPassOutputsToEngineInputs() or equivalent to include balance sheet data",
        "Ensure asset approach calculation uses standalone balance sheet when available",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Updated BalanceSheetData with source, eidl_loan_balance, ppp_loan_balance, working_capital. Updated mapBalanceSheet() to take standalone data with priority. Updated mapPassOutputsToEngineInputs() with options.standaloneBalanceSheet."
    },
    {
      "id": "US-019",
      "title": "Update valuation engine for COVID normalization",
      "description": "As a developer, I need the SDE calculation to subtract COVID one-time items for proper earnings normalization.",
      "acceptanceCriteria": [
        "Update lib/calculations/types.ts with covid_adjustments interface",
        "Add fields: ppp_loan_forgiveness, eidl_advances, employee_retention_credit",
        "Update calculateNormalizedSDE() to subtract COVID adjustments from earnings",
        "Add extraction_note explaining COVID normalization",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Added CovidAdjustmentsData interface. Updated calculateSDEForYear() and calculateNormalizedEarnings() to accept and apply COVID adjustments. COVID items subtracted from SDE for 2020-2021 normalization."
    },
    {
      "id": "US-020",
      "title": "Update orchestrator prompts for new document types",
      "description": "As a developer, I need the AI pass prompts to reference balance sheet and state tax data when available.",
      "acceptanceCriteria": [
        "Update Pass 2 (Financial Analysis) prompt to handle balance sheets separately from tax returns",
        "Add instructions: 'IF BALANCE SHEET PRESENT: Use for asset values, note EIDL/PPP loans, flag shareholder loans'",
        "Update Pass 5 (SDE Calculation) prompt with COVID adjustment rules",
        "Add instructions: 'PPP loan forgiveness: SUBTRACT, EIDL grants: SUBTRACT, ERC: SUBTRACT'",
        "Add balance sheet red flags section to Pass 5 prompt",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Updated Pass 5 with comprehensive COVID adjustment section (E.1) including PPP, EIDL, ERC handling with SUBTRACT treatment. Added balance sheet red flags section (E.2) for loans to shareholders, negative retained earnings, excessive distributions. Pass 2/3 are deprecated in favor of Modal extraction."
    },
    {
      "id": "US-021",
      "title": "Update PDF generator for source document display",
      "description": "As a user, I need the PDF report to show which documents were analyzed for transparency.",
      "acceptanceCriteria": [
        "Add generateSourceDocuments() function to lib/pdf/professional-pdf-generator.ts",
        "Display table with columns: Document, Type, Year for each analyzed document",
        "Format document_type for display (balance_sheet -> 'Balance Sheet', va_form_500 -> 'Virginia Form 500')",
        "Add section after Executive Summary or in Appendix",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": true,
      "notes": "Added source_documents to ReportData interface. Added Source Documents section with table showing Document Type, Filename, Tax Year, Jurisdiction. Section appears before Bibliography in the PDF."
    },
    {
      "id": "US-022",
      "title": "Update PDF generator for COVID adjustment disclosure",
      "description": "As a user, I need the PDF report to disclose any COVID-related adjustments made to the valuation.",
      "acceptanceCriteria": [
        "Add generateCOVIDdisclosure() function to lib/pdf/professional-pdf-generator.ts",
        "Display section only if covid_adjustments has non-zero values",
        "List each adjustment type with amount formatted as currency",
        "Add explanatory text: 'The following pandemic-related items were adjusted in the SDE calculation'",
        "Place in Financial Analysis section or as standalone disclosure",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": true,
      "notes": "Added covid_adjustments to ReportData. Added COVID disclosure section with PPP, EIDL, ERC amounts and explanatory text. Section appears in Financial Analysis after SDE table. Styled with warning colors."
    },
    {
      "id": "US-023",
      "title": "Create integration test for balance sheet extraction",
      "description": "As a developer, I need integration tests to verify balance sheet extraction produces correct results.",
      "acceptanceCriteria": [
        "Create test file lib/extraction/__tests__/balance-sheet-extraction.test.ts",
        "Test with mock balance sheet data matching kfactor6.pdf structure",
        "Verify total_assets, total_liabilities, total_equity extracted correctly",
        "Verify EIDL/PPP loan detection in covid_adjustments",
        "Verify red_flags populated for loans_to_shareholders, negative_retained_earnings",
        "Tests pass",
        "Typecheck passes"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Create integration test for Virginia Form 500 extraction",
      "description": "As a developer, I need integration tests to verify VA Form 500 extraction produces correct results.",
      "acceptanceCriteria": [
        "Create test file lib/extraction/__tests__/va-form-500-extraction.test.ts",
        "Test with mock VA Form 500 data matching 2021_VA_Tax_Return.pdf structure",
        "Verify federal_taxable_income, virginia_taxable_income extracted",
        "Verify apportionment_percentage extracted from Schedule 500A",
        "Verify company_info.state = 'VA'",
        "Tests pass",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    }
  ]
}
