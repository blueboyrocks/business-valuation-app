{
  "project": "ValuationPro",
  "branchName": "ralph/prd-h-data-consistency-fix",
  "description": "PRD-H: Data Consistency Fix - Fix value inconsistencies between AI-generated narratives and calculation tables. Root cause: narratives hallucinate values, then RECONCILE logic incorrectly picks narrative values over calculations. STRATEGY: Build ALL verification tools FIRST so every fix can be verified immediately.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add Structured Logging for Critical Values",
      "description": "As a developer, I need immediate visibility into what values are being used during PDF generation so that I can debug issues without parsing the full PDF. This is the quickest win - gives immediate insight into the data flow.",
      "acceptanceCriteria": [
        "Locate PDF generation code in lib/pdf/professional-pdf-generator.ts",
        "Add console.log statements for all critical values at point of use in the generate() method",
        "Log format: console.log('[MANIFEST] metric=value section=name')",
        "Required logs: final_value, revenue, sde_normalized, sde_weighted, asset_approach, income_approach, market_approach, sde_multiple, cap_rate, dlom_percentage, value_range_low, value_range_high",
        "Add summary log at end: console.log('[MANIFEST] GENERATION_COMPLETE values_logged=N')",
        "Logs should use accessor methods when available (accessor?.getFinalValue(), etc.)",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Quick win (<30 min). The PDF generator already has an accessor parameter. Add logging at the start of generate() and/or buildHTML()."
    },
    {
      "id": "US-002",
      "title": "Create JSON Manifest Generator with Supabase Storage",
      "description": "As a developer, I need a JSON manifest generated with every PDF and stored in Supabase so that automated tests can verify consistency. The manifest should contain all critical values and track where each value appears.",
      "acceptanceCriteria": [
        "Create /lib/valuation/manifest-generator.ts",
        "Interface ReportManifest with: generated_at, valuation_id, critical_values (all numeric fields), value_appearances (map of metric to array of {section, value}), consistency_check ({passed, errors, warnings})",
        "Function generateManifest(accessor: ValuationDataAccessor, valuationId: string): ReportManifest",
        "critical_values includes: revenue_current_year, sde_normalized, sde_weighted, final_concluded_value, value_range_low, value_range_high, asset_approach_value, income_approach_value, market_approach_value, sde_multiple_used, cap_rate, dlom_percentage, approach_weights (asset/income/market)",
        "Create Supabase migration: ALTER TABLE reports ADD COLUMN manifest_json JSONB",
        "Update download-pdf route to save manifest to reports.manifest_json after PDF generation",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Core testing infrastructure. Manifest stored in Supabase enables querying without regenerating PDF. Migration file goes in supabase/migrations/."
    },
    {
      "id": "US-003",
      "title": "Create Manifest Consistency Validator",
      "description": "As a developer, I need an automated validator that checks manifest consistency so that fixes can be verified programmatically without manual PDF inspection.",
      "acceptanceCriteria": [
        "Create /lib/valuation/manifest-validator.ts",
        "Function validateManifest(manifest: ReportManifest): ManifestValidationResult",
        "Check: All appearances of same metric have identical value (within 1% tolerance for currency)",
        "Check: Approach weights sum to 1.0 (within 0.001 tolerance)",
        "Check: Value range valid (low < final < high)",
        "Check: Math correct (weighted_value ≈ sum of approach × weight, within 2%)",
        "Check: No zero values for required fields (final_value, revenue, at least one approach > 0)",
        "Return { passed: boolean, errors: string[], warnings: string[] }",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "This validator checks the MANIFEST for internal consistency. Different from the existing quality-gate which checks section text."
    },
    {
      "id": "US-004",
      "title": "Add Mini-Report Test Mode for Visual Verification",
      "description": "As a developer, I need a mini-report mode that generates a 5-10 page PDF with all critical values for quick visual verification. The manifest alone cannot verify visual rendering issues like [object Object] or misplaced values.",
      "acceptanceCriteria": [
        "Add testMode parameter to PDF generation: POST /api/reports/[id]/download-pdf?testMode=true",
        "Mini-report includes only: Cover page, Critical Values Summary Table, Executive Summary, Valuation Approaches Summary, Value Reconciliation",
        "Critical Values Summary Table shows all authoritative values in one place (revenue, SDE, approaches, weights, final value, range)",
        "Mini-report is < 10 pages, < 50KB",
        "Mini-report uses same accessor/data flow as full report (not a separate code path)",
        "All critical values appear at least once in mini-report",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "MOVED UP from priority 11. Visual verification catches issues manifest misses: [object Object] bugs, formatting issues, narrative contradicting tables. Essential for confirming fixes actually work."
    },
    {
      "id": "US-005",
      "title": "Fix Asset Approach Showing $0",
      "description": "As a valuation analyst, I need the Asset Approach to show the correct value when assets exist. K-Force has $2.2M assets and $1.1M liabilities, so asset approach should show ~$1.1M, not $0.",
      "acceptanceCriteria": [
        "Search codebase for where asset_approach_value gets set to 0 or overwritten",
        "Check lib/calculations/asset-approach-calculator.ts - verify calculation is correct",
        "Check data flow: calculation engine -> DataStore -> DataAccessor -> PDF",
        "Add logging: console.log('[ASSET_APPROACH] totalAssets=%d liabilities=%d calculated=%d final=%d')",
        "If value is being overwritten downstream, find and fix the overwrite",
        "Verify DataAccessor.getApproachValue('asset') returns non-zero for K-Force",
        "Generate test manifest and verify asset_approach_value > 0",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "First real fix. K-Force expected: ~$1,132,935 (not $0). The asset-approach-calculator.ts already has a fallback chain (from US-005 in previous PRD) but something downstream may be zeroing it."
    },
    {
      "id": "US-006",
      "title": "Find and Remove RECONCILE Override Logic",
      "description": "As a system, calculations must ALWAYS win over AI-generated narrative values. Session handoff documented '[RECONCILE] Using narrative value for asset_approach_value: $8,512,000' in logs - this is backwards and must be fixed.",
      "acceptanceCriteria": [
        "Search entire codebase for: RECONCILE, reconcile, 'narrative value', 'Using narrative', override patterns",
        "Check lib/extraction/narrative-data-extractor.ts - the reconcileWithNarratives() function",
        "Check app/api/reports/[id]/regenerate/route.ts for any narrative-to-calculation override",
        "Identify any code path where AI-extracted values overwrite calculation engine values",
        "Ensure hasCalculationEngine flag is being passed and respected (added in previous PRD)",
        "Data flow must be one-directional: Tax Data → Calculations → DataStore → Narratives (narratives receive, never modify)",
        "Add logging: console.log('[DATA_FLOW] Source for %s: %s (calc=%d, narrative=%d)')",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Critical fix. Previous PRD added hasCalculationEngine guard but the RECONCILE log suggests it's not working or there's another code path. Need to trace the full data flow."
    },
    {
      "id": "US-007",
      "title": "Enhance Narrative Value Injector",
      "description": "As a system, the existing narrative-value-injector.ts should replace ALL hallucinated values in AI narratives with authoritative calculation values. Currently it's not catching the K-Force inconsistencies.",
      "acceptanceCriteria": [
        "Read lib/valuation/narrative-value-injector.ts to understand current patterns",
        "Add logging: console.log('[INJECTOR] Section: %s, Found: %d values, Replaced: %d')",
        "Ensure it handles ALL currency formats: $1,234,567, $1.2M, $1.2 million, 1.2 million dollars",
        "Ensure it covers Executive Summary section (where K-Force issues appear)",
        "Add patterns for value ranges (e.g., '$3.8M to $4.6M' should be replaced with correct range)",
        "Add patterns for SDE multiples (e.g., '4.9x' should be replaced with correct multiple)",
        "Verify injector runs AFTER narrative generation but BEFORE any RECONCILE logic",
        "Run on K-Force and verify executive summary values get corrected",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Enhance existing file, don't create new. The injector exists but isn't catching all the K-Force issues. Key question: is it running at the right point in the pipeline?"
    },
    {
      "id": "US-008",
      "title": "Verify DataAccessor Wiring in All PDF Sections",
      "description": "As a system, every financial value in the PDF must come from the DataAccessor. Previous PRD wired many sections but there may be gaps where raw reportData values are still used.",
      "acceptanceCriteria": [
        "Audit lib/pdf/professional-pdf-generator.ts for any direct reportData.* access for financial values",
        "Search for patterns like: reportData.final_value, reportData.revenue, reportData.sde, reportData.asset_approach",
        "Replace any remaining direct reportData financial value access with accessor methods",
        "Ensure ALL narrative sections that mention financial values go through the value injector",
        "Verify no section calculates its own values (e.g., computing SDE multiple inline)",
        "Document which sections are accessor-wired vs narrative-injected",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Previous PRD did extensive wiring (US-007 through US-009). This story verifies completeness and catches any gaps."
    },
    {
      "id": "US-009",
      "title": "Debug and Fix Quality Gate",
      "description": "As a system, the quality gate should BLOCK PDF generation when values are inconsistent. The K-Force report with 3 different SDE values should never have passed. Find out why it didn't block and fix it.",
      "acceptanceCriteria": [
        "Check app/api/reports/[id]/download-pdf/route.ts - is quality gate actually running?",
        "Check if quality gate errors are being caught and swallowed silently",
        "Add logging: console.log('[QUALITY_GATE] Score: %d, CanProceed: %s, Errors: %j')",
        "Verify quality gate receives correct sectionContents (including executive summary narrative)",
        "Verify consistency-validator is checking executive summary values against authoritative values",
        "If K-Force has inconsistent values, quality gate MUST return canProceed: false",
        "Test by generating K-Force PDF and checking quality gate output in logs",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "The quality gate exists (lib/validation/quality-gate.ts) and is wired (from US-027 previous PRD). But it's not blocking K-Force. Either it's not running, errors are swallowed, or the checks aren't matching the actual inconsistencies."
    },
    {
      "id": "US-010",
      "title": "Wire Value Injection into Narrative Generation",
      "description": "As a system, AI narrative prompts should receive authoritative values so the AI is less likely to hallucinate. The value-injection.ts system exists but may not be wired into all narrative passes.",
      "acceptanceCriteria": [
        "Check lib/claude/orchestrator.ts (or orchestrator-v2.ts) for where narrative passes run",
        "Verify generateAuthoritativeValuesBlock() from lib/narratives/value-injection.ts is prepended to narrative prompts",
        "Ensure Executive Summary pass (pass 11a or similar) receives the values block",
        "Add logging: console.log('[NARRATIVE_PROMPT] Section: %s, Values block length: %d chars')",
        "Verify the values block contains accurate values from DataAccessor",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Previous PRD created lib/narratives/value-injection.ts and US-026 was supposed to wire it into orchestrator but is marked PENDING. This may be the missing link."
    },
    {
      "id": "US-011",
      "title": "Integration Test: Manifest Validation",
      "description": "As a developer, I need to run the full pipeline on test data and verify the manifest shows consistent values, confirming all fixes work together.",
      "acceptanceCriteria": [
        "Create test script at scripts/test-manifest-consistency.ts",
        "Script creates a mock DataStore with known values (use realistic generic business data)",
        "Script generates a manifest using generateManifest()",
        "Script runs validateManifest() and logs results",
        "Script verifies: final_value consistent, approach values match weights calculation, no zero required values",
        "Script can be run via: npx ts-node scripts/test-manifest-consistency.ts",
        "Script outputs clear PASS/FAIL with details",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Automated verification that the manifest system works correctly with known data. Separate from K-Force which has real data."
    },
    {
      "id": "US-012",
      "title": "K-Force Test Report: Verify All Fixes",
      "description": "As a QA engineer, I need to generate a K-Force report and verify all values are consistent to confirm the complete fix. This is the final gate - if this passes, PRD-H is complete.",
      "acceptanceCriteria": [
        "Trigger K-Force PDF generation (via UI or API)",
        "Check logs for [MANIFEST], [INJECTOR], [QUALITY_GATE], [DATA_FLOW] entries",
        "Query Supabase for the generated manifest_json",
        "Run validateManifest() on the stored manifest - must return passed: true",
        "Verify: final_value same in ALL sections (exec summary, conclusion, reconciliation)",
        "Verify: revenue same in ALL mentions",
        "Verify: SDE values clearly distinguished (normalized vs weighted) or consistent",
        "Verify: asset_approach_value > 0 (should be ~$1.1M)",
        "Verify: value_range is $1.9M-$2.6M (not $3.8M-$4.6M)",
        "Verify: sde_multiple is ~2.5x (not 4.9x)",
        "No '[object Object]' or 'undefined' anywhere in manifest or logs",
        "If using mini-report mode, visually confirm values look correct",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "FINAL GATE. If US-012 passes, PRD-H is complete. Expected K-Force values: Final ~$2.27M, Range $1.93M-$2.61M, SDE Multiple ~2.5x, Asset ~$1.1M."
    }
  ]
}
